# **Automatic script to delete excess buckets**

There is an application (note this app is under **/opt/splunk/etc/apps**, so this will not be deployed throught the indexers) on **Indexer Cluster Master** named **auto_excessive_bucket_deletion** where an automatic script removes all the excessive buckets copies from the environment indexes every **first Wednesday of every month**.

- This script is executed by Splunk itself using the admin account. This script does not need any Linux cronjob.

![image.png](/.attachments/image-3992186d-9767-4c8c-ae6a-0c47775d47cb.png)
- The **passAuth = admin** statement gives us the capability to execute this script with the Splunk admin account without using thycotic at all.
- All the logs generated by the script are being ingested into **dttl_internal_<environment>**
- The **read tok** statement provides the session token of the user who run this script, in this case is the admin account.

![image.png](/.attachments/image-cfaf3b1a-98de-4995-bc37-0a36b5b09732.png)
- Then we use the **tok variable** to execute the **privilege** command

![image.png](/.attachments/image-b1c94da6-98de-44e1-a657-bbf6ecb90fec.png)

The result of this script execution will be like this:

![image.png](/.attachments/image-9376d44a-547e-4bbf-bf3b-369278b504ab.png)

--------------------------------------------------------------------------------
Below are all the scripts associated with the prod service account crontab from the SHC. (Specifically 003).
 
1. 10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 
This script deletes all savedsearch.conf files from the user directory, as users shouldn’t be creating their own scheduled searches outside of apps. It leaves savedsearches in search, SplunkEnterpriseSecurity, and launcher alone.
 
 
2. 10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
 
This script deletes all savedsearch.conf files from the user directory, as users shouldn’t be creating their own scheduled searches outside of apps.
 
3. 55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
 
This script deletes access metadata from the local savedsearches.conf config file, to prevent custom permissions from being set.
 
4. 50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
Clear local default.meta from the apps specified in the app_list.txt file 
 
5. /home/dtt_sc_splunk_prd/clear_local.sh
Clear local default.meta from the apps specified in the app_list.txt file 
 
6. Documented elsewhere (rsync backup script)
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* /opt/DA-ESS-Americas-Lookups/old

 
  Crontab as of Dec 12, 2019

[dtt_sc_splunk_prd@usatramekj003 ~]$ crontab -l
 
 0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* /opt/DA-ESS-Americas-Lookups/old
10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
 

--------------------------------------------------------------------------------
Crontab line 1 &2
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* 
/opt/DA-ESS-Americas-Lookups/old
 
There is a back up of the lookup files app DA-ESS-Americas-Lookups configured in a cron job rsync on two servers.
1.                  usatramekj0031
2.                  usatramekj101
Who?: The cron job is running as the splunk user.
What?: Backups of DA-ESS-Americas-Lookups (/opt/splunk/etc/apps/DA-ESS-Americas-Lookups/lookups)
Where?:
1.                  Latest copy from last 24 hours usatramekj003:/opt/DA-ESS-Americas-Lookups/current and usatramekj101:/opt/DA-ESS-Americas-Lookups/old
2.                  Copy from 2 days before usatramekj003:/opt/DA-ESS-Americas-Lookups/current and usatramekj101:/opt/DA-ESS-Americas-Lookups/old
How?: cron, rsync. rolls over every day and copies to old.
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 /2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/ /opt/DA-ESS-Americas-Lookups/old
Why?: To keep a backup of DA-ESS-Americas-Lookups in case of issues with the lookups in prod.
 
 
 
 
 
 
 
 
 
 
 
 
 
10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 
10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
 
 
55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
 
50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
 
 
/home/dtt_sc_splunk_prd/clear_local.sh
 
Clear local savedsearch.conf from apps.
 
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/clear_local.sh
#!/bin/bash
APPS_DIR="/opt/splunk/etc/apps"
while read LINE; do
mv $APPS_DIR/$LINE/local/savedsearches.conf $APPS_DIR/$LINE/local/savedsearches.
conf.bak
grep '^\(\[.*\]\|disabled.*\)' $APPS_DIR/$LINE/local/savedsearches.conf.bak > $A
PPS_DIR/$LINE/local/savedsearches.conf
done < clear_list.txt
 
 
3. /home/dtt_sc_splunk_prd/ access_delete.sh
This script deletes access metadata.
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/access_delete.sh
#!/bin/bash
APPS_DIR="/opt/splunk/etc/apps"
while read LINE; do
sed -i '/^access.*/d' $APPS_DIR/$LINE/metadata/local.meta
done < app_list.txt
 
2./home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
This script delete all savedsearch.conf files.
 
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
#!/bin/bash
SPLUNK_USER_DIR=/opt/splunk/etc/users
cd $SPLUNK_USER_DIR
find . -regex ".*savedsearches.conf" -print0 | xargs -0 -I filepath cp --parents
filepath ~/user_backups
if [ $? -eq 0 ]
then
find . -regex ".*savedsearches.conf" | grep -v "a-" | xargs -d '\n' -I filepath
rm filepath
else
            echo "could not copy, did not remove old files"
fi
 
 
/home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
This script removes all user savedsearch.conf files.
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 
#!/bin/bash
SPLUNK_USER_DIR=/opt/splunk/etc/users
cd $SPLUNK_USER_DIR
find . -regex ".*savedsearches.conf" -print0 | xargs -0 -I filepath cp --parents filepath ~/user_backups
if [ $? -eq 0 ]
then
find . -regex ".*savedsearches.conf" | grep "/search/\|SplunkEnterpriseSecuritySuite\|launcher" | grep -v "a-" | xargs -d '\
n' -I filepath rm filepath
else
            echo "could not copy, did not remove old files"
fi
 
 
 
 

Errors:
Extra character in crontab on 003:
��/home/dtt_sc_splunk_prd/clean_dispatch.sh: No such file or directory
 
Commented out:
#* */2 * * * /home/dtt_sc_splunk_prd/clean_dispatch.sh >> /home/dtt_sc_splunk_prd/dispatch.log
#*/5 * * * * /home/dtt_sc_splunk_prd/clean_dispatch_by_usage.sh >> /home/dtt_sc_splunk_prd/dispatch.log
 
 
 
Appendix:
[dtt_sc_splunk_prd@usatramekj003 ~]$ crontab -l
#* */2 * * * /home/dtt_sc_splunk_prd/clean_dispatch.sh >> /home/dtt_sc_splunk_prd/dispatch.log
#*/5 * * * * /home/dtt_sc_splunk_prd/clean_dispatch_by_usage.sh >> /home/dtt_sc_splunk_prd/dispatch.log
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* /opt/DA-ESS-Americas-Lookups/old
10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
 
 
 
 
-------------------------------------------------------------------------------- 
[dtt_sc_splunk_prd@usatramekj003 ~]$ crontab -l
 
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* /opt/DA-ESS-Americas-Lookups/old
10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
 --------------------------------------------------------------------------------
 
 
Crontab line 1 &2
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 */2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/* /opt/DA-ESS-Americas-Lookups/old
 
There is a back up of the lookup files app DA-ESS-Americas-Lookups configured in a cron job rsync on two servers.
usatramekj0031
2.                  usatramekj101
Who?: The cron job is running as the splunk user.
What?: Backups of DA-ESS-Americas-Lookups (/opt/splunk/etc/apps/DA-ESS-Americas-Lookups/lookups)
Where?:
Latest copy from last 24 hours usatramekj003:/opt/DA-ESS-Americas-Lookups/current and usatramekj101:/opt/DA-ESS-Americas-Lookups/old
2.                  Copy from 2 days before usatramekj003:/opt/DA-ESS-Americas-Lookups/current and usatramekj101:/opt/DA-ESS-Americas-Lookups/old
How?: cron, rsync. rolls over every day and copies to old.
0 23 * * * rsync --update -raz /opt/splunk/etc/apps/DA-ESS-Americas-Lookups/* /opt/DA-ESS-Americas-Lookups/current
0 2 /2 * * rsync -va --delete-after /opt/DA-ESS-Americas-Lookups/current/ /opt/DA-ESS-Americas-Lookups/old
Why?: To keep a backup of DA-ESS-Americas-Lookups in case of issues with the lookups in prod.
 --------------------------------------------------------------------------------
10 2 * * 1,3,5 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 
10 2 * * 0 /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
 
55 0 * * 2,5 /home/dtt_sc_splunk_prd/access_delete.sh
 
50 0 * * 2,5 /home/dtt_sc_splunk_prd/clear_local.sh
 
 
4. /home/dtt_sc_splunk_prd/clear_local.sh
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/clear_local.sh
#!/bin/bash
APPS_DIR="/opt/splunk/etc/apps"
while read LINE; do
mv $APPS_DIR/$LINE/local/savedsearches.conf $APPS_DIR/$LINE/local/savedsearches.
conf.bak
grep '^\(\[.*\]\|disabled.*\)' $APPS_DIR/$LINE/local/savedsearches.conf.bak > $A
PPS_DIR/$LINE/local/savedsearches.conf
done < clear_list.txt
 
 
3. /home/dtt_sc_splunk_prd/ access_delete.sh
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/access_delete.sh
#!/bin/bash
APPS_DIR="/opt/splunk/etc/apps"
while read LINE; do
sed -i '/^access.*/d' $APPS_DIR/$LINE/metadata/local.meta
done < app_list.txt
 
2./home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
 
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf_nowhitelist.sh
#!/bin/bash
SPLUNK_USER_DIR=/opt/splunk/etc/users
cd $SPLUNK_USER_DIR
find . -regex ".*savedsearches.conf" -print0 | xargs -0 -I filepath cp --parents
filepath ~/user_backups
if [ $? -eq 0 ]
then
find . -regex ".*savedsearches.conf" | grep -v "a-" | xargs -d '\n' -I filepath
rm filepath
else
            echo "could not copy, did not remove old files"
fi
 
 
/home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 --------------------------------------------------------------------------------
[dtt_sc_splunk_prd@usatramekj003 ~]$ more /home/dtt_sc_splunk_prd/remove_all_user_savedsearchconf.sh
 
#!/bin/bash
SPLUNK_USER_DIR=/opt/splunk/etc/users
cd $SPLUNK_USER_DIR
find . -regex ".*savedsearches.conf" -print0 | xargs -0 -I filepath cp --parents filepath ~/user_backups
if [ $? -eq 0 ]
then
find . -regex ".*savedsearches.conf" | grep "/search/\|SplunkEnterpriseSecuritySuite\|launcher" | grep -v "a-" | xargs -d '\
n' -I filepath rm filepath
else
            echo "could not copy, did not remove old files"
fi
 
 
 
 